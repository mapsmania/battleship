<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Shareable WebRTC Street-View Game</title>

<link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>

<style>
body{
  font-family:system-ui,Roboto,Arial,sans-serif;
  background:#f0f2f5;
  display:flex;justify-content:center;align-items:center;
  height:100vh;margin:0;text-align:center;
}
.container{
  background:#fff;padding:1.5rem;border-radius:12px;
  box-shadow:0 8px 30px rgba(0,0,0,.12);
  width:90%;max-width:900px;
}
h1{color:#00796b;margin-top:0}
#connectionPanel{
  display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:1rem;
}
#connectionPanel input,#connectionPanel button{
  padding:.5rem .8rem;font-size:1rem;border:1px solid #ccc;border-radius:8px;
}
#connectionPanel button{
  background:#00796b;color:#fff;border:none;cursor:pointer;
}
#connectionPanel button:disabled{background:#9e9e9e}
#map{height:500px;width:100%;border-radius:8px;border:1px solid #ddd}
#streetViewContainer img{max-width:100%;border-radius:8px;border:1px solid #ccc;margin-bottom:1rem;}
#gameStatus{margin-top:1rem;font-weight:500;color:#555;min-height:1.5rem}
@media(max-width:600px){#map{height:70vh}}
</style>
</head>
<body>
<div class="container">
  <h1>Street-View Guessing Game</h1>
  <div id="connectionPanel">
    <input id="roomIdInput" placeholder="Room ID">
    <input id="userNameInput" placeholder="Your Name">
    <button id="createRoomBtn" onclick="createSession()">Create Room</button>
    <button id="joinRoomBtn" onclick="joinSession()">Join Room</button>
  </div>

  <div id="streetViewContainer"></div>
  <div id="map"></div>
  <p id="gameStatus">Create or join a room to start playing.</p>
</div>

<script>
class SharedMap {
  constructor(){
    this.roomId='';
    this.userName='';
    this.isHost=false;
    this.myUserId=Math.floor(Math.random()*10000)+1;
    this.opponentUserId=null;
    this.connected=false;

    // Map state
    this.map=null;
    this.myMarker=null;
    this.peerMarkers={};

    // SignalR / WebRTC
    this.signalRConnection=null;
    this.peerConnection=null;
    this.dataChannel=null;

    // Street-view game
    this.properties=[];
    this.currentProperty=null;
    this.guesses={};

    this.initializeMap();
  }

  initializeMap(){
    this.map=new maplibregl.Map({
      container:'map',
      style:'https://demotiles.maplibre.org/style.json',
      center:[0,0],
      zoom:2
    });
    this.map.on('click', e=>{
      this.placeOrMoveMyMarker(e.lngLat.lng, e.lngLat.lat);
    });
    this.updateStatus('Click on the map to place your marker.');
  }

  placeOrMoveMyMarker(lng, lat){
    const label=this.userName || 'You';
    if(!this.myMarker){
      this.myMarker=new maplibregl.Marker({color:'#00796b'})
        .setLngLat([lng,lat])
        .setPopup(new maplibregl.Popup().setText(label))
        .addTo(this.map);
      this.myMarker.togglePopup();
    } else {
      this.myMarker.setLngLat([lng,lat]);
      if(this.myMarker.getPopup()) this.myMarker.getPopup().setText(label);
    }

    if(this.connected) this.sendMapData('marker-update',{lng,lat,userId:this.myUserId,userName:this.userName});
    this.guesses[this.myUserId]={lng,lat};
    this.checkForBothGuesses();
  }

  handleMarkerUpdate(d){
    if(!d||d.userId===this.myUserId) return;
    if(!this.peerMarkers[d.userId]){
      const popup=new maplibregl.Popup({offset:12}).setText(d.userName||`Peer ${d.userId}`);
      this.peerMarkers[d.userId]=new maplibregl.Marker({color:'#d9534f'})
        .setLngLat([d.lng,d.lat])
        .setPopup(popup)
        .addTo(this.map);
      this.peerMarkers[d.userId].togglePopup();
    } else {
      this.peerMarkers[d.userId].setLngLat([d.lng,d.lat]);
      if(d.userName) this.peerMarkers[d.userId].getPopup().setText(d.userName);
    }
  }

  updateStatus(msg){document.getElementById('gameStatus').textContent=msg;console.log(msg);}

  sendMapData(type,data){
    if(this.dataChannel && this.dataChannel.readyState==='open'){
      this.dataChannel.send(JSON.stringify({type,data}));
    }
  }

  handleMapMessage(msg){
    if(!msg||!msg.type) return;
    switch(msg.type){
      case 'marker-update': this.handleMarkerUpdate(msg.data); break;
      case 'street-view':
        this.currentProperty=msg.data;
        this.showStreetView(msg.data);
        break;
      case 'guess': this.handlePeerGuess(msg.data); break;
      default: console.warn('Unknown message type',msg.type);
    }
  }

  handlePeerGuess(d){
    if(!d||d.userId===this.myUserId) return;
    this.guesses[d.userId]={lng:d.lng,lat:d.lat};
    if(!this.peerMarkers[d.userId]){
      const popup=new maplibregl.Popup({offset:12}).setText(d.userName||`Peer ${d.userId}`);
      this.peerMarkers[d.userId]=new maplibregl.Marker({color:'#d9534f'})
        .setLngLat([d.lng,d.lat])
        .setPopup(popup)
        .addTo(this.map);
      this.peerMarkers[d.userId].togglePopup();
    } else {
      this.peerMarkers[d.userId].setLngLat([d.lng,d.lat]);
    }
    this.checkForBothGuesses();
  }

  checkForBothGuesses(){
    if(!this.currentProperty) return;
    if(Object.keys(this.guesses).length<2) return;
    const actual={lng:this.currentProperty.longitude,lat:this.currentProperty.latitude};
    const results=[];
    for(const [uid,g] of Object.entries(this.guesses)){
      results.push({uid,distKm:this.haversine(g.lat,g.lng,actual.lat,actual.lng)});
    }
    const winner=results[0].distKm<results[1].distKm?results[0].uid:results[1].uid;
    this.updateStatus(`Round over! Actual location: ${this.currentProperty.formattedAddress}. Player ${winner===this.myUserId?this.userName:'Opponent'} was closer.`);
    new maplibregl.Marker({color:'green'}).setLngLat([actual.lng,actual.lat])
      .setPopup(new maplibregl.Popup().setText('Actual Location'))
      .addTo(this.map).togglePopup();
  }

  haversine(lat1,lon1,lat2,lon2){
    const R=6371,toRad=x=>x*Math.PI/180;
    const dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1);
    const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  }

  showStreetView(property){
    this.currentProperty=property;
    const pano=property.streetView;
    const imgUrl=`https://api.tripgeo.com/api/StreetViewImage/${pano.panoId}_${pano.direction}`;
    document.getElementById('streetViewContainer').innerHTML=`<img src="${imgUrl}" alt="Street View">`;
    this.updateStatus('Look at the street-view above and click on the map to guess.');
  }

  async connectToTripGeoHub(){
    const hubUrl=`https://api.tripgeo.com/teamhub?userid=${this.myUserId}&teamid=shared_map_temp`;
    this.signalRConnection=new signalR.HubConnectionBuilder().withUrl(hubUrl).withAutomaticReconnect().build();

    this.signalRConnection.on('WebRTCPeerJoined', (userName,userId)=>{
      if(userId!==this.myUserId){
        this.opponentUserId=userId;
        if(this.isHost){
          this.updateStatus(`${userName} joined. Sending street-view...`);
          if(this.currentProperty) this.sendMapData('street-view',this.currentProperty);
          else this.loadRandomStreetView();
        } else {
          this.updateStatus(`${userName} joined. Waiting for street-view from host...`);
        }
      }
    });

    this.signalRConnection.on('WebRTCSignalingMessageReceived', (fromUserId,messageType,messageData)=>{
      if(fromUserId!==this.myUserId) this.handleSignalingMessage(messageType,messageData);
    });

    this.signalRConnection.on('WebRTCPeerLeft', (userId)=>{
      if(this.peerMarkers[userId]) this.peerMarkers[userId].remove();
      delete this.peerMarkers[userId];
      this.updateStatus('Peer disconnected.');
    });

    await this.signalRConnection.start();
    this.updateStatus('Connected to TripGeo hub.');
  }

  async loadRandomStreetView(){
    const res=await fetch("https://api.tripgeo.com/api/rentcast");
    const data=await res.json();
    this.properties=data.filter(p=>p.streetView&&p.streetView.hasStreetView);
    if(!this.properties.length){this.updateStatus('No street-view data available.'); return;}
    const prop=this.properties[Math.floor(Math.random()*this.properties.length)];
    this.showStreetView(prop);
    if(this.connected) this.sendMapData('street-view',prop);
  }

  // Placeholder for signaling methods
  handleSignalingMessage(type,data){ /* implement offer/answer/ice handling if needed */ }
}

// --- create game instance ---
const game=new SharedMap();

// --- UI functions ---
async function createSession(){
  const room=document.getElementById('roomIdInput').value.trim();
  const name=document.getElementById('userNameInput').value.trim();
  if(!room||!name){alert('Enter room and name');return;}
  game.roomId=room; game.userName=name; game.isHost=true;
  await game.connectToTripGeoHub();
  await game.signalRConnection.invoke("JoinWebRTCSession",`map_${room}`,game.myUserId);
  game.updateStatus(`Room "${room}" created. Waiting for players...`);
  document.getElementById('createRoomBtn').disabled=true;
  document.getElementById('joinRoomBtn').disabled=true;
  game.loadRandomStreetView();
}

async function joinSession(){
  const room=document.getElementById('roomIdInput').value.trim();
  const name=document.getElementById('userNameInput').value.trim();
  if(!room||!name){alert('Enter room and name');return;}
  game.roomId=room; game.userName=name; game.isHost=false;
  await game.connectToTripGeoHub();
  await game.signalRConnection.invoke("JoinWebRTCSession",`map_${room}`,game.myUserId);
  game.updateStatus(`Joining room "${room}"...`);
  document.getElementById('createRoomBtn').disabled=true;
  document.getElementById('joinRoomBtn').disabled=true;
}
</script>
</body>
</html>
