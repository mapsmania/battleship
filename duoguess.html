<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Tripgeo WebRTC Street-View Game</title>

<link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>

<style>
body{
  font-family:system-ui,Roboto,Arial,sans-serif;
  background:#f0f2f5;
  display:flex;justify-content:center;align-items:center;
  height:100vh;margin:0;text-align:center;
}
.container{
  background:#fff;padding:1.5rem;border-radius:12px;
  box-shadow:0 8px 30px rgba(0,0,0,.12);
  width:90%;max-width:900px;
}
h1{color:#00796b;margin-top:0}
#connectionPanel{
  display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:1rem;
}
#connectionPanel input,#connectionPanel button{
  padding:.5rem .8rem;font-size:1rem;border:1px solid #ccc;border-radius:8px;
}
#connectionPanel button{
  background:#00796b;color:#fff;border:none;cursor:pointer;
}
#connectionPanel button:disabled{background:#9e9e9e}
#map{height:500px;width:100%;border-radius:8px;border:1px solid #ddd;margin-bottom:1rem;}
#streetViewContainer img{max-width:100%;border-radius:8px;border:1px solid #ccc;}
#gameStatus{margin-top:1rem;font-weight:500;color:#555;min-height:1.5rem}
@media(max-width:600px){#map{height:70vh}}
</style>
</head>

<body>
<div class="container">
  <h1>Street-View Guessing Game</h1>
  <div id="connectionPanel">
    <input id="roomIdInput" placeholder="Room ID">
    <input id="userNameInput" placeholder="Your Name">
    <button id="createRoomBtn" onclick="createSession()">Create Room</button>
    <button id="joinRoomBtn"   onclick="joinSession()">Join Room</button>
  </div>

  <div id="streetViewContainer"></div>
  <div id="map"></div>
  <p id="gameStatus">Create or join a room to start playing.</p>
</div>

<script>
class StreetViewGame {
  constructor(){
    this.roomId=null;
    this.userName=null;
    this.myUserId=Math.floor(Math.random()*10000)+1;
    this.isHost=false;
    this.map=null;
    this.myMarker=null;
    this.peerMarkers={};
    this.guesses={};
    this.currentProperty=null;
    this.signalRConnection=null;
    this.opponentUserId=null;

    this.initializeMap();
  }

  initializeMap(){
    this.map=new maplibregl.Map({
      container:'map',
      style:'https://tiles.openfreemap.org/styles/liberty',
      center:[0,0],
      zoom:2
    });
    this.map.on('click', e => this.placeOrMoveMyMarker(e.lngLat.lng,e.lngLat.lat));
  }

  placeOrMoveMyMarker(lng,lat){
    const label=this.userName||'You';
    if(!this.myMarker){
      this.myMarker=new maplibregl.Marker({color:'#00796b'})
        .setLngLat([lng,lat])
        .setPopup(new maplibregl.Popup({offset:12}).setText(label))
        .addTo(this.map);
      this.myMarker.togglePopup();
    } else {
      this.myMarker.setLngLat([lng,lat]);
      const popup=this.myMarker.getPopup();
      if(popup) popup.setText(label);
    }

    // store our guess
    this.guesses[this.myUserId]={lng,lat};

    this.sendMapData('marker-update',{lng,lat,userId:this.myUserId,userName:this.userName});

    // check for scoring
    this.checkForBothGuesses();
  }

  async connectToTripgeoHub(){
    if(this.signalRConnection) return;

    const hubUrl=`https://api.tripgeo.com/teamhub?userid=${this.myUserId}&teamid=shared_map_temp`;
    this.signalRConnection=new signalR.HubConnectionBuilder()
      .withUrl(hubUrl)
      .withAutomaticReconnect()
      .build();

    // Peer joined
    this.signalRConnection.on('WebRTCPeerJoined',(userName,userId)=>{
      if(userId!==this.myUserId){
        this.opponentUserId=userId;
        if(this.isHost){
          this.updateStatus(`${userName} joined. Loading street-view...`);
          this.loadRandomStreetView();
        } else {
          this.updateStatus(`${userName} joined. Waiting for street-view...`);
        }
      }
    });

    // Received messages
    this.signalRConnection.on('WebRTCSignalingMessageReceived',async(fromUserId,messageType,messageData)=>{
      if(fromUserId!==this.myUserId){
        if(messageType==='street-view'){
          this.showStreetView(messageData);
        } else if(messageType==='marker-update'){
          this.handlePeerGuess(messageData);
        }
      }
    });

    await this.signalRConnection.start();
    this.updateStatus('Connected to Tripgeo hub.');
  }

  async sendStreetView(property){
    if(!this.opponentUserId) return;
    await this.signalRConnection.invoke('SendWebRTCSignalingMessage',this.opponentUserId.toString(),'street-view',property);
  }

  async loadRandomStreetView(){
    try{
      const res=await fetch('https://api.tripgeo.com/api/rentcast');
      const data=await res.json();
      const properties=data.filter(p=>p.streetView && p.streetView.hasStreetView);
      if(!properties.length){ this.updateStatus('No street-view available'); return; }

      const property=properties[Math.floor(Math.random()*properties.length)];
      this.currentProperty=property;
      this.showStreetView(property);

      if(this.isHost) await this.sendStreetView(property);
    }catch(err){
      console.error(err);
      this.updateStatus('Failed to load street-view data.');
    }
  }

  showStreetView(property){
    const pano=property.streetView;
    const imgUrl=`https://api.tripgeo.com/api/StreetViewImage/${pano.panoId}_${pano.direction}`;
    document.getElementById('streetViewContainer').innerHTML=`<img src="${imgUrl}" alt="Street View">`;
    this.updateStatus('Look at the street-view above and click on the map to guess.');
  }

  sendMapData(type,data){
    if(!this.signalRConnection || !this.opponentUserId) return;
    this.signalRConnection.invoke('SendWebRTCSignalingMessage',this.opponentUserId.toString(),type,data).catch(console.error);
  }

  handlePeerGuess(data){
    if(!data || data.userId===this.myUserId) return;
    this.guesses[data.userId]={lng:data.lng,lat:data.lat};

    if(!this.peerMarkers[data.userId]){
      const popup=new maplibregl.Popup({offset:12}).setText(data.userName||'Peer');
      this.peerMarkers[data.userId]=new maplibregl.Marker({color:'#d9534f'})
        .setLngLat([data.lng,data.lat])
        .setPopup(popup)
        .addTo(this.map);
      this.peerMarkers[data.userId].togglePopup();
    } else {
      this.peerMarkers[data.userId].setLngLat([data.lng,data.lat]);
    }

    this.checkForBothGuesses();
  }

  checkForBothGuesses(){
    if(!this.currentProperty) return;
    if(Object.keys(this.guesses).length<2) return;

    const actual={lng:this.currentProperty.longitude,lat:this.currentProperty.latitude};
    const results=[];

    for(const [uid,g] of Object.entries(this.guesses)){
      const dist=this.haversine(g.lat,g.lng,actual.lat,actual.lng);
      results.push({uid,dist});
    }

    const winner=results[0].dist<results[1].dist?results[0].uid:results[1].uid;
    const winnerName=winner===this.myUserId?this.userName:'Opponent';

    this.updateStatus(`Round over! Actual location: ${this.currentProperty.formattedAddress}. ${winnerName} was closer.`);

    // show actual location
    new maplibregl.Marker({color:'green'})
      .setLngLat([actual.lng,actual.lat])
      .setPopup(new maplibregl.Popup().setText("Actual Location"))
      .addTo(this.map)
      .togglePopup();
  }

  // Haversine formula to compute distance in km
  haversine(lat1,lon1,lat2,lon2){
    const R=6371, toRad=x=>x*Math.PI/180;
    const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
    const a=Math.sin(dLat/2)**2 +
            Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  }

  updateStatus(msg){ document.getElementById('gameStatus').innerText=msg; }
}
</script>
</body>
</html>
