<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Shareable WebRTC Street-View Game</title>

<link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>

<style>
body{
  font-family:system-ui,Roboto,Arial,sans-serif;
  background:#f0f2f5;
  display:flex;justify-content:center;align-items:center;
  height:100vh;margin:0;text-align:center;
}
.container{
  background:#fff;padding:1.5rem;border-radius:12px;
  box-shadow:0 8px 30px rgba(0,0,0,.12);
  width:90%;max-width:900px;
}
h1{color:#00796b;margin-top:0}
#connectionPanel{
  display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:1rem;
}
#connectionPanel input,#connectionPanel button{
  padding:.5rem .8rem;font-size:1rem;border:1px solid #ccc;border-radius:8px;
}
#connectionPanel button{
  background:#00796b;color:#fff;border:none;cursor:pointer;
}
#connectionPanel button:disabled{background:#9e9e9e}
#map{height:500px;width:100%;border-radius:8px;border:1px solid #ddd}
#gameStatus{margin-top:1rem;font-weight:500;color:#555;min-height:1.5rem}
@media(max-width:600px){#map{height:70vh}}
</style>
</head>

<body>
<div class="container">
  <h1>Street-View Guessing Game</h1>
  <div id="connectionPanel">
    <input id="roomIdInput" placeholder="Room ID">
    <input id="userNameInput" placeholder="Your Name">
    <button id="createRoomBtn" onclick="createSession()">Create Room</button>
    <button id="joinRoomBtn"   onclick="joinSession()">Join Room</button>
  </div>

  <div id="streetViewContainer" style="margin-bottom:1rem"></div>
  <div id="map"></div>
  <p id="gameStatus">Create or join a room to start playing.</p>
</div>

<script>
/* ----------------------------------------------------------
   BASIC SHARED MAP  (simplified – no geolocation anymore)
-----------------------------------------------------------*/
class SharedMap {
  constructor(){
    this.roomId=null;
    this.userName=null;
    this.myUserId=Math.random().toString(36).slice(2);
    this.isHost=false;
    this.map=null;
    this.myMarker=null;
    this.peerMarkers={};
    this.signalRConnection=null;
    this.dataChannel=null;

    this.initializeMapSession();
  }

  initializeMapSession(){
    this.map=new maplibregl.Map({
      container:'map',
      style:'https://demotiles.maplibre.org/style.json',
      center:[0,0],
      zoom:2
    });
    this.map.on('click',e=>{
      this.placeOrMoveMyMarker(e.lngLat.lng,e.lngLat.lat);
    });
  }

  async connectToSignaling(){
    this.signalRConnection=new signalR.HubConnectionBuilder()
       .withUrl("/webrtcHub")
       .build();
    await this.signalRConnection.start();

    // Relay messages
    this.signalRConnection.on("ReceiveMapMessage",(roomId,msg)=>{
      if(roomId===`map_${this.roomId}`) this.handleMapMessage(JSON.parse(msg));
    });
  }

  sendMapData(type,data){
    const payload=JSON.stringify({type,data});
    this.signalRConnection.invoke("SendMapMessage",`map_${this.roomId}`,payload);
  }

  updateStatus(t){
    document.getElementById('gameStatus').innerText=t;
  }

  placeOrMoveMyMarker(lng,lat){
    if(!this.myMarker){
      this.myMarker=new maplibregl.Marker({color:'#00796b'})
        .setLngLat([lng,lat])
        .setPopup(new maplibregl.Popup().setText(this.userName||'Me'))
        .addTo(this.map);
      this.myMarker.togglePopup();
    }else{
      this.myMarker.setLngLat([lng,lat]);
    }
    this.sendMapData('marker-update',{userId:this.myUserId,userName:this.userName,lng,lat});
  }

  handleMarkerUpdate(d){
    if(d.userId===this.myUserId) return;
    if(!this.peerMarkers[d.userId]){
      this.peerMarkers[d.userId]=new maplibregl.Marker({color:'#d9534f'})
        .setLngLat([d.lng,d.lat])
        .setPopup(new maplibregl.Popup().setText(d.userName||'Peer'))
        .addTo(this.map);
      this.peerMarkers[d.userId].togglePopup();
    }else{
      this.peerMarkers[d.userId].setLngLat([d.lng,d.lat]);
    }
  }

  handleMapMessage(msg){
    if(msg.type==='marker-update') this.handleMarkerUpdate(msg.data);
  }
}

/* ----------------------------------------------------------
   STREET-VIEW GAME  (extends SharedMap)
-----------------------------------------------------------*/
class StreetViewGame extends SharedMap{
  constructor(){
    super();
    this.properties=[];
    this.currentProperty=null;
    this.guesses={};
  }

  async loadRandomStreetView(){
    try{
      const res=await fetch("https://api.tripgeo.com/api/rentcast");
      const data=await res.json();
      this.properties=data.filter(p=>p.streetView && p.streetView.hasStreetView);
      if(!this.properties.length){
        this.updateStatus("No street-view data available.");
        return;
      }
      const property=this.properties[Math.floor(Math.random()*this.properties.length)];
      this.showStreetView(property);

      // share with the other player
      this.sendMapData('street-view',property);

    }catch(err){
      console.error(err);
      this.updateStatus("Failed to load street-view data.");
    }
  }

  /* reusable display method */
  showStreetView(property){
    this.currentProperty=property;
    const pano=property.streetView;
    const imgUrl=`https://maps.googleapis.com/maps/api/streetview?size=600x400&pano=${pano.panoId}&heading=${pano.direction}&pitch=0&key=YOUR_GOOGLE_KEY`;
    document.getElementById('streetViewContainer').innerHTML=
      `<img src="${imgUrl}" alt="Street View"
             style="max-width:100%;border-radius:8px;border:1px solid #ccc;">`;
    this.updateStatus("Look at the street-view above and click on the map to guess.");
  }

  placeOrMoveMyMarker(lng,lat){
    super.placeOrMoveMyMarker(lng,lat);
    this.guesses[this.myUserId]={lng,lat};
    this.sendMapData('guess',{lng,lat,userId:this.myUserId,userName:this.userName});
    this.checkForBothGuesses();
  }

  handleMapMessage(msg){
    if(msg.type==='guess') this.handlePeerGuess(msg.data);
    else if(msg.type==='street-view') this.showStreetView(msg.data);
    else super.handleMapMessage(msg);
  }

  handlePeerGuess(d){
    if(!d || d.userId===this.myUserId) return;
    this.guesses[d.userId]={lng:d.lng,lat:d.lat};

    if(!this.peerMarkers[d.userId]){
      this.peerMarkers[d.userId]=new maplibregl.Marker({color:'#d9534f'})
        .setLngLat([d.lng,d.lat])
        .setPopup(new maplibregl.Popup().setText(d.userName||'Peer'))
        .addTo(this.map);
      this.peerMarkers[d.userId].togglePopup();
    }else{
      this.peerMarkers[d.userId].setLngLat([d.lng,d.lat]);
    }
    this.checkForBothGuesses();
  }

  checkForBothGuesses(){
    if(!this.currentProperty) return;
    if(Object.keys(this.guesses).length<2) return;

    const actual={lng:this.currentProperty.longitude,lat:this.currentProperty.latitude};
    const results=[];
    for(const [uid,g] of Object.entries(this.guesses)){
      const distKm=this.haversine(g.lat,g.lng,actual.lat,actual.lng);
      results.push({uid,distKm});
    }
    const winner=results[0].distKm < results[1].distKm ? results[0].uid:results[1].uid;

    this.updateStatus(
      `Round over! Actual location was at ${this.currentProperty.formattedAddress}.
       Player ${winner===this.myUserId?this.userName:'Opponent'} was closer.`
    );

    new maplibregl.Marker({color:'green'})
      .setLngLat([actual.lng,actual.lat])
      .setPopup(new maplibregl.Popup().setText("Actual Location"))
      .addTo(this.map)
      .togglePopup();
  }

  haversine(lat1,lon1,lat2,lon2){
    const R=6371,toRad=x=>x*Math.PI/180;
    const dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1);
    const a=Math.sin(dLat/2)**2 +
            Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  }
}

/* ----------------------------------------------------------
   INIT + ROOM JOIN / CREATE
-----------------------------------------------------------*/
const game=new StreetViewGame();

async function createSession(){
  const room=document.getElementById('roomIdInput').value.trim();
  const name=document.getElementById('userNameInput').value.trim();
  if(!room||!name){alert('Enter room and name');return;}

  game.roomId=room; game.userName=name; game.isHost=true;

  await game.connectToSignaling();
  await game.signalRConnection.invoke("JoinWebRTCSession",`map_${room}`,game.myUserId);
  game.updateStatus(`Room "${room}" created. Waiting for players…`);
  document.getElementById('createRoomBtn').disabled=true;
  document.getElementById('joinRoomBtn').disabled=true;

  // load first round
  game.loadRandomStreetView();
}

async function joinSession(){
  const room=document.getElementById('roomIdInput').value.trim();
  const name=document.getElementById('userNameInput').value.trim();
  if(!room||!name){alert('Enter room and name');return;}

  game.roomId=room; game.userName=name; game.isHost=false;

  await game.connectToSignaling();
  await game.signalRConnection.invoke("JoinWebRTCSession",`map_${room}`,game.myUserId);
  game.updateStatus(`Joining room "${room}"…`);
  document.getElementById('createRoomBtn').disabled=true;
  document.getElementById('joinRoomBtn').disabled=true;
}
</script>
</body>
</html>
