<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>TripGeo Street-View Guessing Game</title>

<link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>

<style>
body { font-family: system-ui,Roboto,Arial,sans-serif; background:#f0f2f5; display:flex; justify-content:center; align-items:center; height:100vh; margin:0; text-align:center;}
.container{background:#fff;padding:1.5rem;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.12); width:90%;max-width:900px;}
h1{color:#00796b;margin-top:0;}
#connectionPanel{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:1rem;}
#connectionPanel input,#connectionPanel button{padding:.5rem .8rem;font-size:1rem;border:1px solid #ccc;border-radius:8px;}
#connectionPanel button{background:#00796b;color:#fff;border:none;cursor:pointer;}
#connectionPanel button:disabled{background:#9e9e9e;}
#map{height:400px;width:100%;border-radius:8px;border:1px solid #ddd;margin-bottom:1rem;}
#streetViewContainer img{max-width:100%;border-radius:8px;border:1px solid #ccc;}
#gameStatus{margin-top:1rem;font-weight:500;color:#555;min-height:1.5rem;}
@media(max-width:600px){#map{height:60vh;}}
</style>
</head>

<body>
<div class="container">
  <h1>Street-View Guessing Game</h1>
  <div id="connectionPanel">
    <input id="roomIdInput" placeholder="Room ID">
    <input id="userNameInput" placeholder="Your Name">
    <button id="createRoomBtn" onclick="createSession()">Create Room</button>
    <button id="joinRoomBtn" onclick="joinSession()">Join Room</button>
  </div>

  <div id="streetViewContainer"></div>
  <div id="map"></div>
  <p id="gameStatus">Enter a room to start playing.</p>
</div>

<script>
class StreetViewMap {
  constructor() {
    this.roomId = '';
    this.userName = '';
    this.isHost = false;
    this.connected = false;
    this.myUserId = Math.floor(Math.random() * 10000) + 1;
    this.opponentUserId = null;

    this.map = null;
    this.myMarker = null;
    this.peerMarkers = {};
    this.guesses = {};
    this.currentProperty = null;

    this.signalRConnection = null;
    this.dataChannel = null;

    this.initMap();
  }

  initMap() {
    this.map = new maplibregl.Map({
      container: 'map',
      style: 'https://tiles.openfreemap.org/styles/liberty',
      center: [-0.09,51.505],
      zoom: 12
    });

    this.map.on('click', e => {
      this.placeOrMoveMarker(e.lngLat.lng, e.lngLat.lat);
    });
  }

  placeOrMoveMarker(lng, lat) {
    if (!this.myMarker) {
      this.myMarker = new maplibregl.Marker({color:'#00796b'})
        .setLngLat([lng, lat])
        .setPopup(new maplibregl.Popup({ offset:12 }).setText(this.userName || 'You'))
        .addTo(this.map);
      this.myMarker.togglePopup();
    } else {
      this.myMarker.setLngLat([lng, lat]);
    }

    this.guesses[this.myUserId] = {lng, lat};
    this.sendMapData('guess', {lng, lat, userId:this.myUserId, userName:this.userName});
    this.checkForBothGuesses();
  }

  async connectToTripGeoHub() {
    if (this.signalRConnection) return;

    const hubUrl = `https://api.tripgeo.com/teamhub?userid=${this.myUserId}&teamid=shared_map_temp`;
    this.signalRConnection = new signalR.HubConnectionBuilder()
      .withUrl(hubUrl)
      .withAutomaticReconnect()
      .build();

    this.signalRConnection.on("WebRTCPeerJoined", (userName, userId) => {
      if (userId !== this.myUserId) {
        this.opponentUserId = userId;
        if (this.isHost) this.loadRandomStreetView();
      }
    });

    this.signalRConnection.on("WebRTCSignalingMessageReceived", (fromUserId, messageType, messageData) => {
      // we donâ€™t handle offer/answer here; TripGeo handles WebRTC internally
      console.log("Signaling message from", fromUserId, messageType);
    });

    await this.signalRConnection.start();
    this.updateStatus('Connected to TripGeo hub.');
  }

  sendMapData(type, data) {
    if (!this.signalRConnection || !this.opponentUserId) return;
    const payload = JSON.stringify({type,data});
    this.signalRConnection.invoke("SendMapMessage", this.opponentUserId.toString(), payload)
      .catch(console.error);
  }

  handleMapMessage(msg) {
    if (!msg || !msg.type) return;
    switch(msg.type){
      case 'guess': this.handlePeerGuess(msg.data); break;
      case 'street-view': this.showStreetView(msg.data); break;
      default: console.warn('Unknown message type', msg.type);
    }
  }

  handlePeerGuess(data) {
    if (!data || data.userId === this.myUserId) return;
    this.guesses[data.userId] = {lng:data.lng, lat:data.lat};

    if (!this.peerMarkers[data.userId]) {
      const popup = new maplibregl.Popup({offset:12}).setText(data.userName || 'Peer');
      this.peerMarkers[data.userId] = new maplibregl.Marker({color:'#d9534f'})
        .setLngLat([data.lng, data.lat])
        .setPopup(popup)
        .addTo(this.map);
      this.peerMarkers[data.userId].togglePopup();
    } else {
      this.peerMarkers[data.userId].setLngLat([data.lng, data.lat]);
    }

    this.checkForBothGuesses();
  }

  async loadRandomStreetView() {
    try {
      const res = await fetch("https://api.tripgeo.com/api/rentcast");
      const data = await res.json();
      const properties = data.filter(p => p.streetView && p.streetView.hasStreetView);
      if (!properties.length) { this.updateStatus("No street-view data."); return; }
      const property = properties[Math.floor(Math.random()*properties.length)];
      this.currentProperty = property;

      const pano = property.streetView;
      const imgUrl = `https://api.tripgeo.com/api/StreetViewImage/${pano.panoId}_${pano.direction}`;
      document.getElementById('streetViewContainer').innerHTML = `<img src="${imgUrl}">`;

      this.updateStatus("Look at the street-view above and click on the map to guess.");
      // notify peer
      this.sendMapData('street-view', property);
    } catch(err) {
      console.error(err);
      this.updateStatus("Failed to load street-view data.");
    }
  }

  checkForBothGuesses() {
    if (!this.currentProperty) return;
    if (Object.keys(this.guesses).length < 2) return;

    const actual = {lat:this.currentProperty.latitude, lng:this.currentProperty.longitude};
    const results = [];
    for (const [uid, g] of Object.entries(this.guesses)) {
      results.push({uid, dist:this.haversine(g.lat,g.lng,actual.lat,actual.lng)});
    }

    const winner = results[0].dist < results[1].dist ? results[0].uid : results[1].uid;
    this.updateStatus(`Round over! Actual location: ${this.currentProperty.formattedAddress}. Winner: ${winner===this.myUserId?this.userName:'Opponent'}`);

    new maplibregl.Marker({color:'green'})
      .setLngLat([actual.lng, actual.lat])
      .setPopup(new maplibregl.Popup().setText("Actual Location"))
      .addTo(this.map)
      .togglePopup();
  }

  haversine(lat1, lon1, lat2, lon2){
    const R=6371, toRad=x=>x*Math.PI/180;
    const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
    const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  updateStatus(msg) { document.getElementById('gameStatus').textContent = msg; }
}

// ---- Initialize game ----
const game = new StreetViewMap();

async function createSession() {
  const roomId = document.getElementById('roomIdInput').value.trim();
  const userName = document.getElementById('userNameInput').value.trim();
  if (!roomId||!userName){alert('Enter room and name'); return;}

  game.roomId = roomId; game.userName = userName; game.isHost=true;
  await game.connectToTripGeoHub();
  game.updateStatus(`Room "${roomId}" created. Waiting for other player...`);
}

async function joinSession() {
  const roomId = document.getElementById('roomIdInput').value.trim();
  const userName = document.getElementById('userNameInput').value.trim();
  if (!roomId||!userName){alert('Enter room and name'); return;}

  game.roomId = roomId; game.userName = userName; game.isHost=false;
  await game.connectToTripGeoHub();
  game.updateStatus(`Joined room "${roomId}". Waiting for host to start round...`);
}
</script>
</body>
</html>
